<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>フロージェネレーター</title>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 20px; 
      max-width: 800px;
      margin: 0 auto;
    }
    select, input, button { 
      padding: 5px; 
      margin: 3px;
    }
    #output { 
      width: 100%; 
      height: 300px; 
      margin-top: 10px;
      font-family: monospace;
    }
    .action-select {
      margin-bottom: 15px;
    }
    .image-selector {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 5px;
    }
    .key-help {
      font-size: 12px;
      color: #666;
      margin: 5px 0;
      background: #f5f5f5;
      padding: 5px;
      border-radius: 3px;
    }
    .section-header {
      background: #eee;
      padding: 5px;
      margin-top: 10px;
      font-weight: bold;
      border-radius: 3px;
    }
    .action-type {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>フロージェネレーター</h1>
  
  <div class="action-select">
    <div class="action-type">
      <label for="action-type">アクションタイプ:</label>
      <select id="action-type">
        <optgroup label="基本操作">
          <option value="sleep">待機</option>
          <option value="screenshot">スクリーンショット</option>
          <option value="includeflow">サブフロー</option>
        </optgroup>
        <optgroup label="UI操作">
          <option value="presskeys">キー操作</option>
          <option value="hotkey">ホットキー</option>
          <option value="typetext">テキスト入力</option>
          <option value="click">クリック</option>
          <option value="moveto">座標移動</option>
          <option value="movetoimage">画像へ移動</option>
          <option value="waitforimage">画像待機</option>
          <option value="dragonimage">画像ドラッグ</option>
          <option value="openurl">URLを開く</option>
          <option value="screenshotregion">範囲スクリーンショット</option>
        </optgroup>
        <optgroup label="変数操作">
          <option value="setvariable">変数設定</option>
          <option value="stringoperation">文字列操作</option>
          <option value="getclipboard">クリップボード取得</option>
          <option value="setclipboard">クリップボードへコピー</option>
        </optgroup>
        <optgroup label="フロー制御">
          <option value="loop">ループ処理</option>
          <option value="foreach">配列反復処理</option>
          <option value="condition">条件分岐</option>
        </optgroup>
        <optgroup label="ファイル操作">
          <option value="loadtextfile">テキストファイル読込</option>
          <option value="loadtextfiletolist">テキストファイル行読込</option>
        </optgroup>
        <optgroup label="システム操作">
          <option value="openfolder">フォルダを開く</option>
          <option value="runexecutable">プログラム実行</option>
        </optgroup>
      </select>
    </div>
    <div id="params-container"></div>
    <button id="add-btn">追加</button>
  </div>
  
  <textarea id="output" readonly></textarea>
  <button id="copy-btn">コピー</button>

  <script>
    // DOM要素
    const actionSelect = document.getElementById('action-type');
    const paramsContainer = document.getElementById('params-container');
    const addBtn = document.getElementById('add-btn');
    const output = document.getElementById('output');
    const copyBtn = document.getElementById('copy-btn');
    
    // キー操作のヘルプ
    const keyHelp = `
      よく使うキー: enter(Enter), tab(Tab), space(スペース), backspace(BS), delete(Del), escape(Esc)
      方向キー: up(↑), down(↓), left(←), right(→)
      機能キー: f1～f12(F1～F12)
      修飾キー: shift, ctrl, alt, win
      複数の修飾キーを組み合わせる場合はホットキーを使用！
    `;
    
    // ホットキーのヘルプ
    const hotkeyHelp = `
      1つ目のパラメータで修飾キーを指定: 'ctrl', 'alt', 'shift', 'win' など
      2つ目のパラメータで通常キーを指定: 'c', 'v', 'a', 'f4' など
      例: HotKey('ctrl', 'c') はCtrl+Cを表します
      複数の修飾キーを組み合わせる場合: 'ctrl, shift' のようにカンマ区切りで指定
    `;
    
    // 変数のヘルプ
    const variableHelp = `
      変数名は$プレフィックスなしで指定します (例: "username")
      変数を参照する場合は$プレフィックスを使用します (例: "$username")
    `;
    
    // 文字列操作ヘルプ
    const stringOpHelp = `
      トリム: パラメータ不要
      左から取得: パラメータ1に文字数
      右から取得: パラメータ1に文字数
      範囲指定: パラメータ1に開始位置、パラメータ2に終了位置
      置換: パラメータ1に検索文字列、パラメータ2に置換文字列
      指定語の前: パラメータ1に区切り文字列
      指定語の後: パラメータ1に区切り文字列
      連結: パラメータ1に連結する文字列（変数参照可）
    `;
    
    // パラメータ定義
    const actionParams = {
      sleep: [
        { id: 'seconds', label: '秒数', type: 'number', default: 1 }
      ],
      openurl: [
        { id: 'url', label: 'URL', type: 'text', default: 'https://example.com' },
        { id: 'wait', label: '待機(秒)', type: 'number', default: 5 },
        { id: 'mode', label: 'ウィンドウモード', type: 'select', 
          options: ['normal', 'fullscreen', 'left_half', 'right_half'], 
          labels: ['通常', '全画面', '左半分', '右半分'],
          default: 'normal' }
      ],
      waitforimage: [
        { id: 'images', label: '画像ファイル（複数可）', type: 'image-select', count: 5, default: '' },
        { id: 'timeout', label: 'タイムアウト', type: 'number', default: 30 },
        { id: 'confidence', label: '信頼度', type: 'number', default: 0.8 }
      ],
      click: [
        { id: 'button', label: 'ボタン', type: 'select', options: ['left', 'right'], default: 'left' },
        { id: 'type', label: 'クリックタイプ', type: 'select', 
          options: ['click', 'doubleclick', 'rightclick', 'mousedown', 'mouseup'], 
          labels: ['クリック', 'ダブルクリック', '右クリック', '押しっぱなし', '離す'], 
          default: 'click' }
      ],
      moveto: [
        { id: 'x', label: 'X座標', type: 'number', default: 100 },
        { id: 'y', label: 'Y座標', type: 'number', default: 100 },
        { id: 'duration', label: '時間(秒)', type: 'number', default: 0.5 }
      ],
      movetoimage: [
        { id: 'images', label: '画像ファイル（複数可）', type: 'image-select', count: 5, default: '' },
        { id: 'duration', label: '時間(秒)', type: 'number', default: 0.5 }
      ],
      dragonimage: [
        { id: 'start', label: '開始画像', type: 'image-select', count: 1, default: '' },
        { id: 'end', label: '終了画像（空白ならオフセット使用）', type: 'image-select', count: 1, default: '' },
        { id: 'offset_x', label: 'X移動量', type: 'number', default: 100 },
        { id: 'offset_y', label: 'Y移動量', type: 'number', default: 0 },
        { id: 'duration', label: '時間(秒)', type: 'number', default: 1.0 }
      ],
      typetext: [
        { id: 'text', label: 'テキスト', type: 'text', default: 'サンプルテキスト' },
        { id: 'variable_help', label: '', type: 'keyhelp', text: '変数を参照するには$プレフィックスを使用: "$username"' }
      ],
      presskeys: [
        { id: 'keys', label: 'キー(カンマ区切り)', type: 'text', default: 'enter, tab' },
        { id: 'keyhelp', label: '', type: 'keyhelp', text: keyHelp }
      ],
      hotkey: [
        { id: 'modifier', label: '修飾キー', type: 'text', default: 'ctrl' },
        { id: 'key', label: 'キー', type: 'text', default: 'c' },
        { id: 'keyhelp', label: '', type: 'keyhelp', text: hotkeyHelp }
      ],
      screenshot: [],
      screenshotregion: [
        { id: 'x', label: 'X座標', type: 'number', default: 100 },
        { id: 'y', label: 'Y座標', type: 'number', default: 100 },
        { id: 'w', label: '幅', type: 'number', default: 500 },
        { id: 'h', label: '高さ', type: 'number', default: 400 }
      ],
      includeflow: [
        { id: 'path', label: 'パス', type: 'text', default: 'subfolder/subflow' }
      ],
      
      // 変数操作関連
      setvariable: [
        { id: 'name', label: '変数名', type: 'text', default: 'var_name' },
        { id: 'value', label: '値', type: 'text', default: 'sample_value' },
        { id: 'variable_help', label: '', type: 'keyhelp', text: variableHelp }
      ],
      stringoperation: [
        { id: 'var_name', label: '変数名', type: 'text', default: 'var_name' },
        { id: 'operation', label: '操作', type: 'select', 
          options: ['trim', 'left', 'right', 'slice', 'replace', 'before', 'after', 'concat'],
          labels: ['トリム', '左から取得', '右から取得', '範囲指定', '置換', '指定語の前', '指定語の後', '連結'],
          default: 'trim' },
        { id: 'param1', label: 'パラメータ1', type: 'text', default: '' },
        { id: 'param2', label: 'パラメータ2', type: 'text', default: '' },
        { id: 'operation_help', label: '', type: 'keyhelp', text: stringOpHelp }
      ],
      getclipboard: [
        { id: 'var_name', label: '格納する変数名', type: 'text', default: 'clipboard_content' }
      ],
      setclipboard: [
        { id: 'content', label: '内容', type: 'text', default: 'テキスト内容' },
        { id: 'variable_help', label: '', type: 'keyhelp', text: '変数を参照するには$プレフィックスを使用: "$var_name"' }
      ],
      
      // フロー制御関連
      loop: [
        { id: 'count', label: '繰り返し回数', type: 'text', default: '3' },
        { id: 'nested_help', label: '', type: 'keyhelp', text: 'ループ内のアクションは追加後に個別に設定してください。\n回数の代わりに変数を指定する場合は$プレフィックスを使用: "$count_var"' }
      ],
      foreach: [
        { id: 'list_var', label: 'リスト変数名', type: 'text', default: 'items' },
        { id: 'item_var', label: '要素変数名', type: 'text', default: 'item' },
        { id: 'nested_help', label: '', type: 'keyhelp', text: 'ForEach内のアクションは追加後に個別に設定してください。\n変数名は$プレフィックスなしで指定します' }
      ],
      condition: [
        { id: 'condition', label: '条件式', type: 'text', default: '$var == "value"' },
        { id: 'nested_help', label: '', type: 'keyhelp', text: '条件式では変数を$プレフィックスで参照します: "$var1 == 10", "len($text) > 0"\n条件分岐内のアクションは追加後に個別に設定してください。' }
      ],
      
      // ファイル操作関連
      loadtextfile: [
        { id: 'file_path', label: 'ファイルパス', type: 'text', default: 'data.txt' },
        { id: 'var_name', label: '格納する変数名', type: 'text', default: 'file_content' },
        { id: 'encoding', label: 'エンコーディング', type: 'text', default: 'utf-8' }
      ],
      loadtextfiletolist: [
        { id: 'file_path', label: 'ファイルパス', type: 'text', default: 'lines.txt' },
        { id: 'var_name', label: '格納する変数名', type: 'text', default: 'lines' },
        { id: 'encoding', label: 'エンコーディング', type: 'text', default: 'utf-8' },
        { id: 'strip', label: '行トリム', type: 'checkbox', default: true }
      ],
      
      // システム操作関連
      openfolder: [
        { id: 'folder_path', label: 'フォルダパス', type: 'text', default: 'ScreenShot' },
        { id: 'variable_help', label: '', type: 'keyhelp', text: '変数を参照するには$プレフィックスを使用: "$folder_path"' }
      ],
      runexecutable: [
        { id: 'exe_path', label: '実行ファイルパス', type: 'text', default: 'notepad.exe' },
        { id: 'args', label: '引数(カンマ区切り)', type: 'text', default: '' },
        { id: 'wait', label: '完了を待つ', type: 'checkbox', default: false },
        { id: 'exe_help', label: '', type: 'keyhelp', text: '.pyファイルも実行可能。引数に変数を使用する場合は$プレフィックスを使用: "$var_name"' }
      ]
    };
    
    // コード生成関数
    function generateCode(type, params) {
      switch(type) {
        // 基本操作
        case 'sleep':
          return `Sleep(${params.seconds}),`;
        case 'openurl': {
          let urlCode = `OpenURL("${params.url}", wait=${params.wait}`;
          if (params.mode && params.mode !== 'normal') {
            urlCode += `, mode="${params.mode}"`;
          }
          return urlCode + '),';
        }
        case 'waitforimage': {
          const images = getSelectedImages(params.images || []);
          if (images.length === 0) {
            alert('画像ファイルを選択してください');
            return null;
          }
          
          if (images.length === 1) {
            return `WaitForImage(r"${images[0]}", timeout=${params.timeout}, confidence=${params.confidence}),`;
          } else {
            const imgList = images.map(img => `r"${img}"`).join(', ');
            return `WaitForAnyImage([${imgList}], timeout=${params.timeout}, confidence=${params.confidence}),`;
          }
        }
        case 'click': {
          const button = params.button;
          const type = params.type;
          
          if (type === 'click') {
            return `Click(button='${button}', clicks=1),`;
          } else if (type === 'doubleclick') {
            return `Click(button='${button}', clicks=2),`;
          } else if (type === 'rightclick') {
            return `RightClick(),`;
          } else if (type === 'mousedown') {
            return `pyautogui.mouseDown(button='${button}'),  # 押しっぱなし`;
          } else if (type === 'mouseup') {
            return `pyautogui.mouseUp(button='${button}'),  # 離す`;
          }
          break;
        }
        case 'moveto':
          return `MoveTo(${params.x}, ${params.y}, duration=${params.duration}),`;
        case 'movetoimage': {
          const images = getSelectedImages(params.images || []);
          if (images.length === 0) {
            alert('画像ファイルを選択してください');
            return null;
          }
          
          if (images.length === 1) {
            return `MoveToImage(r"${images[0]}", duration=${params.duration}),`;
          } else {
            const imgList = images.map(img => `r"${img}"`).join(', ');
            return `MoveToImage([${imgList}], duration=${params.duration}),`;
          }
        }
        case 'dragonimage': {
          const startImg = getSelectedImages(params.start || [])[0];
          const endImg = getSelectedImages(params.end || [])[0];
          
          if (!startImg) {
            alert('開始画像を選択してください');
            return null;
          }
          
          if (endImg) {
            return `DragOnImage(r"${startImg}", end=r"${endImg}", duration=${params.duration}),`;
          } else {
            return `DragOnImage(r"${startImg}", offset=(${params.offset_x}, ${params.offset_y}), duration=${params.duration}),`;
          }
        }
        case 'typetext':
          return `TypeText("${params.text}"),`;
        case 'presskeys': {
          const keyList = params.keys.split(',').map(key => `"${key.trim()}"`).join(', ');
          return `PressKeys([${keyList}]),`;
        }
        case 'hotkey': {
          let modifier = params.modifier.trim();
          const key = params.key.trim();
          
          // 複数の修飾キーをチェック (カンマ区切りされている場合)
          if (modifier.includes(',')) {
            const modifiers = modifier.split(',').map(m => `'${m.trim()}'`).join(', ');
            return `HotKey(${modifiers}, '${key}'),`;
          } else {
            return `HotKey('${modifier}', '${key}'),`;
          }
        }
        case 'screenshot':
          return `Screenshot(),`;
        case 'screenshotregion':
          return `ScreenshotRegion(${params.x}, ${params.y}, ${params.w}, ${params.h}),`;
        case 'includeflow':
          return `IncludeFlow(r"${params.path}"),`;
          
        // 変数操作関連
        case 'setvariable':
          return `SetVariable("${params.name}", "${params.value}"),`;
        case 'stringoperation': {
          const operation = params.operation;
          let param1 = params.param1.trim();
          let param2 = params.param2.trim();
          
          // 操作タイプごとのパラメータ処理
          switch (operation) {
            case 'trim':
              return `StringOperation("${params.var_name}", "trim"),`;
            case 'left':
              return `StringOperation("${params.var_name}", "left", ${param1}),`;
            case 'right':
              return `StringOperation("${params.var_name}", "right", ${param1}),`;
            case 'slice':
              return `StringOperation("${params.var_name}", "slice", ${param1}, ${param2}),`;
            case 'replace':
              return `StringOperation("${params.var_name}", "replace", "${param1}", "${param2}"),`;
            case 'before':
              return `StringOperation("${params.var_name}", "before", "${param1}"),`;
            case 'after':
              return `StringOperation("${params.var_name}", "after", "${param1}"),`;
            case 'concat':
              return `StringOperation("${params.var_name}", "concat", "${param1}"),`;
            default:
              return '';
          }
        }
        case 'getclipboard':
          return `GetClipboard("${params.var_name}"),`;
        case 'setclipboard':
          return `SetClipboard("${params.content}"),`;
          
        // フロー制御関連
        case 'loop': {
          let countValue = params.count.trim();
          return `Loop(${countValue}, [\n    # ここにループ内のアクションを追加\n    Sleep(1),\n]),`;
        }
        case 'foreach': {
          return `ForEach("${params.list_var}", "${params.item_var}", [\n    # ここにループ内のアクションを追加\n    TypeText("$${params.item_var}"),\n]),`;
        }
        case 'condition': {
          return `Condition("${params.condition}", [\n    # 条件がTrue時のアクション\n    Sleep(1),\n], [\n    # 条件がFalse時のアクション\n    Sleep(2),\n]),`;
        }
        
        // ファイル操作関連
        case 'loadtextfile':
          return `LoadTextFile("${params.file_path}", "${params.var_name}", encoding="${params.encoding}"),`;
        case 'loadtextfiletolist': {
          const strip = params.strip ? 'True' : 'False';
          return `LoadTextFileToList("${params.file_path}", "${params.var_name}", encoding="${params.encoding}", strip=${strip}),`;
        }
        
        // システム操作関連
        case 'openfolder':
          return `OpenFolder("${params.folder_path}"),`;
        case 'runexecutable': {
          let args = '';
          if (params.args && params.args.trim()) {
            const argList = params.args.split(',').map(arg => `"${arg.trim()}"`).join(', ');
            args = `, [${argList}]`;
          }
          const wait = params.wait ? ', wait=True' : '';
          return `RunExecutable("${params.exe_path}"${args}${wait}),`;
        }
          
        default:
          return '';
      }
    }
    
    // 選択された画像ファイル名を取得
    function getSelectedImages(fileInputs) {
      if (!Array.isArray(fileInputs)) return [];
      
      return fileInputs
        .filter(input => input && input.files && input.files[0])
        .map(input => input.files[0].name);
    }
    
    // パラメータUIを更新
    actionSelect.addEventListener('change', updateParamsUI);
    
    function updateParamsUI() {
      paramsContainer.innerHTML = '';
      
      const type = actionSelect.value;
      const params = actionParams[type] || [];
      
      params.forEach(param => {
        if (param.type === 'image-select') {
          const container = document.createElement('div');
          const label = document.createElement('label');
          label.textContent = param.label;
          container.appendChild(label);
          
          const imageSelector = document.createElement('div');
          imageSelector.className = 'image-selector';
          
          const count = param.count || 1;
          const inputs = [];
          
          for (let i = 0; i < count; i++) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.dataset.param = param.id;
            inputs.push(input);
            imageSelector.appendChild(input);
          }
          
          container.appendChild(imageSelector);
          paramsContainer.appendChild(container);
          return;
        }
        
        if (param.type === 'keyhelp') {
          const helpDiv = document.createElement('div');
          helpDiv.className = 'key-help';
          helpDiv.textContent = param.text;
          paramsContainer.appendChild(helpDiv);
          return;
        }
        
        const label = document.createElement('label');
        label.textContent = param.label + ': ';
        
        let input;
        if (param.type === 'select') {
          input = document.createElement('select');
          (param.options || []).forEach((opt, index) => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = param.labels ? param.labels[index] : opt;
            input.appendChild(option);
          });
        } else if (param.type === 'checkbox') {
          input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = param.default;
        } else {
          input = document.createElement('input');
          input.type = param.type;
          input.value = param.default;
        }
        
        input.dataset.param = param.id;
        
        label.appendChild(input);
        paramsContainer.appendChild(label);
      });
    }
    
    // 初期UI表示
    updateParamsUI();
    
    // 追加ボタンクリック
    addBtn.addEventListener('click', function() {
      const type = actionSelect.value;
      const params = {};
      
      // 通常パラメータ値の取得
      const inputs = paramsContainer.querySelectorAll('input:not([type="file"]), select');
      inputs.forEach(input => {
        if (!input.dataset.param) return;
        
        if (input.type === 'checkbox') {
          params[input.dataset.param] = input.checked;
        } else {
          let value = input.value;
          if (input.type === 'number') {
            value = parseFloat(value);
          }
          params[input.dataset.param] = value;
        }
      });
      
      // ファイル入力の取得
      const fileGroups = {};
      const fileInputs = paramsContainer.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        if (!input.dataset.param) return;
        
        const paramName = input.dataset.param;
        if (!fileGroups[paramName]) {
          fileGroups[paramName] = [];
        }
        
        fileGroups[paramName].push(input);
      });
      
      // ファイルグループをパラメータに追加
      Object.keys(fileGroups).forEach(paramName => {
        params[paramName] = fileGroups[paramName];
      });
      
      // コード生成
      const code = generateCode(type, params);
      
      // 出力に追加（nullの場合は追加しない）
      if (code) {
        output.value += code + '\n';
      }
    });
    
    // コピーボタン
    copyBtn.addEventListener('click', function() {
      output.select();
      document.execCommand('copy');
    });
  </script>
</body>
</html>
